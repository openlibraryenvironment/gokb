node {
  jdk = tool name: 'OpenJava11'
  env.JAVA_HOME = "${jdk}"

  stage('Test') {
    checkout scm
    dir ('server/gokbg3') {
      sh './gradlew --no-daemon --console plain test'
    }
  }

  stage('Build') {
    cleanWs()
    dir ('server/gokbg3') {
//      def props = readProperties file: 'gradle.properties'
      sh './gradlew --no-daemon --console plain war'
    }
  }

  stage('Deploy') {
     dir ('server/gokbg3') {
        def props = readProperties file: 'gradle.properties'
//        sh "echo ${props.appVersion}"
        sh "cp build/libs/gokbg3-${props.appVersion}.war /opt/tomcat/latest/webapps/gokb.${props.appVersion}#${BUILD_NUMBER}.${branch}.war.bak"
        sh "cp build/libs/gokbg3-${props.appVersion}.war /opt/tomcat/latest/webapps/gokb.war"
     }
  }
}